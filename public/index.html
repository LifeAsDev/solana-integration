<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Solana Pay Demo</title>

		<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.75.0/lib/index.iife.min.js"></script>

		<script src="https://www.unpkg.com/solana-connect"></script>
	</head>
	<body>
		<script src="./main.js"></script>

		<script>
			async function connectWallet() {
				if (solConnect) solConnect.openMenu();
			}
			function check() {
				if (solConnect) {
					console.log(solConnect.activeWallet);
					const wallet = solConnect.getWallet();
					sendTransaction(
						wallet,
						"HeMuWnMKPdrgkTay1swBP3WLd3eeZDWUy4PYPCPkvVDQ",
						0.001
					);
				}
			}
			const sendTransaction = async (
				wallet, // La wallet conectada (Phantom, Solflare, etc.)
				recipient, // Dirección del destinatario
				amount
			) => {
				const { Connection, PublicKey, SystemProgram, Transaction } =
					solanaWeb3;
				const devnet = "https://api.devnet.solana.com";
				const mainnet =
					"https://solana-mainnet.g.alchemy.com/v2/su4NQiUu5uSE_3oMj-_riW_gHXqQPECJ";
				if (!wallet || !wallet.publicKey) {
					console.error("No hay una wallet conectada");
					return;
				}
				console.log({ wallet });
				const connection = new Connection(devnet, "confirmed");

				const transaction = new Transaction().add(
					SystemProgram.transfer({
						fromPubkey: wallet.publicKey,
						toPubkey: new PublicKey(recipient),
						lamports: amount * 10 ** 9, // Convertir SOL a lamports
					})
				);

				try {
					const { blockhash } = await connection.getLatestBlockhash();

					// 2. Asignar el recentBlockhash a la transacción
					transaction.recentBlockhash = blockhash;
					transaction.feePayer = wallet.publicKey; // Establecer el fee payer (¡Importante!)

					// 3. Firmar la transacción
					const signedTransaction = await wallet.signTransaction(transaction);

					// 4. Serializar la transacción firmada
					const serializedTransaction = signedTransaction.serialize();

					// 5. Enviar la transacción
					const { signature } = await connection.sendRawTransaction(
						serializedTransaction
					);

					console.log("Transacción enviada:", signature);
				} catch (error) {
					console.error("Error enviando la transacción:", error);
				}
			};

			function set() {
				const buf = Buffer.from("Hola, mundo!", "utf-8");
				console.log(buf.toString("hex"));
			}
		</script>
		<script>
			const solConnect = new window.SolanaConnect();
		</script>
		<h1>Solana Pay Demo</h1>
		<button onclick="connectWallet()">Conectar Wallet</button>
		<button onclick="check()">Check Wallet</button>

		<p id="wallet-address">No conectado</p>
		<button onclick="sendPayment()">Pagar 0.1 SOL</button>
		<button onclick="set()">set</button>
	</body>
</html>
